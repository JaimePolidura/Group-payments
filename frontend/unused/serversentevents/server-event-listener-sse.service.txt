import { Injectable } from '@angular/core';
import {Authentication} from "../../src/backend/users/authentication/authentication";
import {ServerEvent} from "../../src/backend/eventlistener/notifications/server-event";
import {ServerEventListener} from "../../src/backend/eventlistener/server-event-listener";
import {ReplaySubject} from "rxjs";
import {ServerMessage} from "../../src/backend/server-message";
import {BackendUsingRoutesService} from "../../src/backend/backend-using-routes.service";

@Injectable({
  providedIn: 'root'
})
export class ServerEventListenerSseService implements ServerEventListener{
  private readonly eventEmitter: ReplaySubject<ServerMessage>;
  private eventSource: EventSource;

  constructor(private auth: Authentication, private backendRoutes: BackendUsingRoutesService){
    this.eventEmitter = new ReplaySubject();
  }

  public connect(): void {
    this.eventSource = new EventSource(`${this.backendRoutes.USING}/eventstreaming/sse?token=${this.auth.getToken()}&userId=${this.auth.getUserId()}`);
    this.eventSource.onopen = () => console.log("opened");
    this.eventSource.onmessage = (msg): void => {
      this.onNewEvent(msg);
    }
  }

  public disconnect(): void{
    this.eventSource.close();
  }

  onNewEvent(messageEvent: unknown): void {
    // @ts-ignore
    const eventServerMessage: ServerMessage = JSON.parse(messageEvent.data);

    console.log(eventServerMessage);

    this.eventEmitter.next(eventServerMessage);
  }

  getEventEmitter(): ReplaySubject<ServerMessage> {
    return this.eventEmitter;
  }
}
